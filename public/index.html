<!DOCTYPE html>
<html lang="eng">
  <head>
    <link rel="stylesheet" type="text/css" href="./css/style.css"/>
  </head>
  <body>

    <div>
      <h1>Clover Cloud Connector Unit Examples</h1>
      <a href="https://github.com/clover/clover-cloud-connector-unit-examples">GIT Repository</a>
    </div>

    <p>If redirected to Clover to login, you will need to select a 'test' button again after you log in.</p>

    <table class="config-messages-section">
      <tr>
        <td colspan="2">You can make changes to the configuration and select the [SaveConfig] button to save them. Configurations are identified by their "friendlyId".</td>
      </tr>
      <tr>
        <td>
          <b>Configuration</b>
        </td>
        <td>
          <b>Messages</b>
        </td>
      </tr>
      <tr>
        <td>
          <select name="fiendlyId" id="friendlyId" class="load-config-selector">
            <option value="none">&nbsp;</option>
          </select><br/>
          <textarea title="Configuration" id="configText"></textarea>
          <button class="btn save-config-btn">SaveConfig</button>
          <button class="btn force-disconnect-btn">Force Disconnect</button>
        </td>
        <td>
          <textarea title="Messages" id="infoMessages" readonly></textarea>
          <button class="btn clear-messages-btn">Clear Messages</button>
        </td>
      </tr>
    </table>

    <!-- To add a test, add it to the test-src.js (see testSale(...), then add a button to invoke it here -->
    <div id="tests" class="tests-wrapper">
      <button class="btn brk test-btn" data-test="TestSale">Test Sale</button><br/>
      <button class="btn brk test-btn" data-test="TestAuth">Test Auth</button><br/>
      <button class="btn brk test-btn" data-test="TestPreAuth">Test Pre Auth</button><br/>
      <button class="btn brk test-btn" data-test="TestPreAuthCapture">Test Pre Auth then capture</button><br/>
      <button class="btn brk test-btn" data-test="TestReadCardData">Test Reading Card Data</button><br/>
      <button class="btn brk test-btn" data-test="TestShowMessage">Test Showing a Message</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleTipAdjust">Test doing a sale then a tip adjust (should fail)</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleVoid">Test Voiding a Payment</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleRefund">Test a full refund of a sale</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleRefundErr">Test a full refund of a sale that should FAIL (no order id set)</button><br/>
      <button class="btn brk test-btn" data-test="TestSalePartialRefund">Test a partial refund of a sale</button><br/>
      <button class="btn brk test-btn" data-test="TestShowReceiptOptions">Test showing the receipt screen</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleWithReconnectLogic">Test Sale that tries to reconnect on timeout</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleRefuseReconnectLogic">Test Sale, refuse reconnect request.</button><br/>
      <button class="btn brk test-btn" data-test="TestLogAllFrames">Log all frames.</button><br/>
      <button class="btn brk test-btn" data-test="TestVaultCard">Test Vaulting a card.</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleNullRequest">Test a Sale Failure - missing request</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleNullExternalId">Test a Sale Failure - missing external id</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleNegZeroAmount">Test a Sale Failure - zero amount</button><br/>
      <button class="btn brk test-btn" data-test="TestReadCardDataFail">Test a read card data Failure - 0 card entry methods</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleExceptionProcessing">Test Sale With Exception Processing</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleDoubleReceiptProcessing">Test Sale With Double Receipt Window</button><br/>
      <button class="btn brk test-btn" data-test="TestReset">Test resetting device</button><br/>
      <button class="btn brk test-btn" data-test="TestSaleFailOnTransactionRestart">Test Fail Transaction on restart</button><br/>
      <button class="btn brk test-btn" data-test="TestManualRefund">Test a Manual Refund</button><br/>
    </div>

    <script src="./built/test.js"></script>
    <script>
      /* **************************************************************************
       *  Config functions
       * **************************************************************************/

      // Defaults for base path, config name and configuration.
      const CONFIG_BASE_PATH = './configuration/';
      const DEFAULT_CONFIG_NAME = 'test';
      const DEFAULT_CONFIGURATION = {
        'clientId': 'V1T1VKQC8Y65Y',
        'remoteApplicationId': 'com.clover.remotepay.cloud.unit.examples:0.0.1-beta1',
        'deviceSerialId': 'C031UQ52340045',
        'domain': 'https://dev1.dev.clover.com/',
        'friendlyId': 'test'
      };

      // Use the default config name.
      var configFile = DEFAULT_CONFIG_NAME;

      // Load the default config.
      document.getElementById("configText").value = JSON.stringify(DEFAULT_CONFIGURATION, null, '\t');
      saveConfigStatic();

      function saveConfigStatic() {
        var newConfig = JSON.parse(document.getElementById("configText").value);
        TestBase.simpleCloverConfig.saveCloverConfig(CONFIG_BASE_PATH, newConfig, function() {
          saveConfigStaticResult(newConfig.friendlyId);
        });
      }

      function saveConfigStaticResult(selectedId) {
        collectAvailableConfigs(selectedId);
      }

      function loadConfigStatic() {
        // Get the selected config id.
        var friendlyId = document.getElementById("friendlyId").value;

        // Load the configuration for this id.
        TestBase.simpleCloverConfig.loadCloverConfig(CONFIG_BASE_PATH, {friendlyId: friendlyId}, 
          function(error, configuration) {
            if (!error) {
              configFile = friendlyId;
              document.getElementById("configText").value = JSON.stringify(configuration, null, '\t');
            }
          }.bind(this));
      }

      function collectAvailableConfigs(selectedId) {
        // Clear the available configs first.
        var availableConfigs = document.getElementById("friendlyId");
        for (var idx = availableConfigs.options.length - 1; idx >= 0; idx--) {
          availableConfigs.remove(idx);
        }

        // Get a list of available configs.
        TestBase.simpleCloverConfig.getConfigsList(CONFIG_BASE_PATH, function(error, configs) {
          if (!error) {
            // Fill the available configs drop-down.
            for (var idx in configs.files) {
              // Create a new option.
              var option = document.createElement("option");

              // Set the option text and value.
              option.text = configs.files[idx];
              option.value = configs.files[idx];

              // Check to see if this option is selected.
              if (!!selectedId && option.text == selectedId) {
                // Set the config file name to the selected option.
                configFile = selectedId;
                option.selected = 'selected';
              }

              // Append the new option.
              availableConfigs.appendChild(option);
            }
          }
        });
      }

      /* **************************************************************************
       *  Test functions
       * **************************************************************************/

      function executeTest(testName) {
        // Run the requested test.
        TestBase[testName](CONFIG_BASE_PATH, configFile, function(message) {
          // Process the response message.
          var strMessage = message;
          if (message.deviceErrorEvent) {
            message.error = {};
            message.error.code = message.deviceErrorEvent.code;
            message.error.message = message.deviceErrorEvent.message;
            message.error.type = message.deviceErrorEvent.type;
            delete message.deviceErrorEvent;
          }
          try { strMessage = JSON.stringify(message); } catch(e) {}

          // Update the response messages text area.
          var infoMessagesTextArea = document.getElementById("infoMessages");
          infoMessagesTextArea.value = strMessage + "\n" + infoMessagesTextArea.value;

          // Update UI elements.
          updateUI(testName, message);
        });
      }

      /**
       * Used to update any UI elements with info from a call.
       *
       * @param testName - the name of the test that was run
       * @param message - has optional properties
       *  {message:string, request:BaseRequest, response:BaseResponse, error:Object, success:success}
       */
      function updateUI(testName, message) {
        var testBtnAttr = '[data-test=\''+testName+'\']';
        if (message !== undefined && message.hasOwnProperty('success')) {
          if (message !== undefined && message.success !== undefined && message.success == true) {
            document.querySelector(testBtnAttr).style.background = '-webkit-linear-gradient(#AAFAAA, #00FF00 40%, #4AAA4A)';
            document.querySelector(testBtnAttr).style.color = '#555555';
          }
          else {
            document.querySelector(testBtnAttr).style.background = '-webkit-linear-gradient(#FAAAAA, #FF5454 40%, #AA4A4A)';
            document.querySelector(testBtnAttr).style.color = '#FFFFFF';
          }
        }
        else {
          document.querySelector(testBtnAttr).style.background = '-webkit-linear-gradient(#FAFAFA, #F4F4F4 40%, #E5E5E5)';
          document.querySelector(testBtnAttr).style.color = '#555555';
        }
      }

      function clearMessages() {
        var infoMessagesTextArea = document.getElementById("infoMessages");
        infoMessagesTextArea.value = "";
      }

      function forceDisconnect() {
        var force = new TestBase.ForceDisconnect(CONFIG_BASE_PATH);
        force.run();
      }

      /* **************************************************************************
       *  Click handler functions
       * **************************************************************************/

      // Create button click handlers.
      [...document.querySelectorAll('button.test-btn')].forEach(function(btn) {
        btn.onclick = function(el) {
          // Get the test name.
          var testName = el.target.getAttribute('data-test');

          // Execute the test.
          executeTest(testName);
        }
      });
      document.querySelector('button.clear-messages-btn').onclick = clearMessages;
      document.querySelector('button.force-disconnect-btn').onclick = forceDisconnect;
      document.querySelector('button.save-config-btn').onclick = saveConfigStatic;
      document.querySelector('select.load-config-selector').onchange = loadConfigStatic;
    </script>
  </body>
</html>
